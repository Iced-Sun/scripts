#!/bin/bash

GRUB_CONFIG=/boot/grub/grub.cfg
BOOT_DEVICE="(hd0,gpt1)"
BOOT_DEVICE_UUID="1D89-D9BA"
LINUX_DEVICE="root=/dev/nvme0n1p2 ro rootflags=subvol=machines/exherbo"
KERNEL_OPTS=""

function build_kernel()
{
	echo "Making bzImage...."
	export PATH="/usr/libexec/distcc:${PATH}"
	export DISTCC_HOSTS='10.2.112.3,lzo'
	if make -j6; then
		RELEASE=`<${WORK}/include/config/kernel.release`
		return 0
	else
		return 1
	fi
}

function install_kernel()
{
	echo "Installing kernel...."
	echo -e "\t`cp -v arch/x86_64/boot/bzImage /boot/exherbo/vmlinuz-${RELEASE}`"
	echo -e "\t`cp -v .config /boot/exherbo/config-${RELEASE}`"
	echo -e "\t`cp -v .config /data/repositories/conf/$(hostname)-config-${RELEASE}`"
	echo -e "\t`cp -v System.map /boot/exherbo/System.map-${RELEASE}`"

	echo "Installing modules...."
	make modules_install >/dev/null

	echo "Installing Intel microcode..."
	echo -e "\t`cp -v /lib/firmware/microcode.cpio /boot/microcode.cpio`"

	which dracut 2>&1 >/dev/null && dracut --xz --force /boot/exherbo/initramfs-${RELEASE}.img ${RELEASE}
}

function do_my_grub_config()
{
    cat <<'EOF'
if [ -s $prefix/grubenv ]; then
  load_env
fi

function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

if loadfont unicode ; then
  set gfxmode=auto
  set gfxpayload=keep
  load_video
  insmod gfxterm
  set locale_dir=$prefix/locale
  set lang=zh_CN
  insmod gettext
fi
terminal_output gfxterm

set default=0
set timeout=8
set pager=1
EOF

#    generate_windows_entry
    generate_linux_entry
    generate_rescue_entry
}

function generate_windows_entry()
{
    cat <<EOF
menuentry 'Windows' {
        search --no-floppy --file --set=root /bootmgr
        chainloader +1
}
EOF
}

function generate_linux_entry()
{
		for kernel in `ls /boot/exherbo/vmlinuz* |sort -Vr`; do
				kernel=`basename ${kernel}`
				release=${kernel#vmlinuz-}
				cat <<EOF
menuentry 'Exherbo GNU/Linux, with Linux ${release}' --class exherbo --class gnu-linux --class gnu --class os {
  load_video
  insmod gzio
  insmod part_gpt
  insmod fat
  set root='${BOOT_DEVICE}'
  search --no-floppy --fs-uuid --set=root ${BOOT_DEVICE_UUID}
  echo    'Loading Linux ${release}...'
  linux   /exherbo/vmlinuz-${release} ${LINUX_DEVICE} ${KERNEL_OPTS}
  echo    'Loading initial ramdisk...'
  initrd  /exherbo/microcode.cpio /exherbo/initramfs-${release}.img
}
EOF
    done
}

function generate_rescue_entry()
{
  [[ -d /boot/sysrcd ]] || return 0

  cat <<EOF
menuentry 'SysResCD' {
 set root='${BOOT_DEVICE}'
 search --no-floppy --fs-uuid --set=root ${BOOT_DEVICE_UUID}
 echo    'Loading SysResCD kernel ...'
 # subdir=/sysrcd
 linux /sysrcd/vmlinuz archisobasedir=sysrcd archisolabel=RESCUE804 copytoram setkmap=dvorak
 initrd /sysrcd/intel_ucode.img /sysrcd/amd_ucode.img /sysrcd/sysresccd.img
}
menuentry 'Boot existing Linux System with SysResCD Kernel' {
 set root='${BOOT_DEVICE}'
 search --no-floppy --fs-uuid --set=root ${BOOT_DEVICE_UUID}
 echo    'Loading SysResCD kernel ...'
 linux /sysrcd/vmlinuz archisobasedir=sysrcd archisolabel=RESCUE804 findroot setkmap=dvorak
 initrd /sysrcd/intel_ucode.img /sysrcd/amd_ucode.img /sysrcd/sysresccd.img
}
EOF
}

[[ -f ./kernel/Makefile ]] && WORK=. || WORK=/usr/src/linux
pushd $WORK >/dev/null
build_kernel || exit 1
mount /boot 2>&1 >/dev/null
install_kernel
popd  >/dev/null

if [[ -e /sbin/grub-mkconfig ]] ; then
	do_my_grub_config > ${GRUB_CONFIG}
	#do_grub_mkconfig
else
	do_my_grub_config > ${GRUB_CONFIG}
	#    ${EDITOR} ${GRUB_CONFIG}
fi

umount /boot 2>&1 >/dev/null
